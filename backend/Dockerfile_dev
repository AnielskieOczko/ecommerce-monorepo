# backend/Dockerfile_dev (Corrected and with Final Verification)

# Build stage
FROM eclipse-temurin:21-jdk-alpine AS build
WORKDIR /app

# Copy the entire monorepo context
COPY . .

# Make the root mvnw script executable
RUN chmod +x mvnw

# Build ALL modules using 'install' to ensure dependencies are available
RUN ./mvnw clean install -DskipTests

# ---

# Runtime stage
FROM eclipse-temurin:21-jre-alpine
WORKDIR /app

# Create the directory for product images
RUN mkdir -p /app/product-images && chmod 777 /app/product-images

# Copy the final JAR using its specific, known name
COPY --from=build /app/backend/target/ecommerce_backend-0.0.1-SNAPSHOT.jar app.jar

# --- DIAGNOSTIC STEP ---
# List the contents of the /app directory in the final image to verify the JAR is present.
# This runs right before the ENTRYPOINT.
RUN ls -l /app

EXPOSE 8080
ENTRYPOINT ["java", "-agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005", "-jar", "/app/app.jar"]