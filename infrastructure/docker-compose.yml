# =============================================================================
# Docker Compose Configuration for E-commerce Microservices
# Reads all variables from the sibling '.env' file.
# =============================================================================
services:
  # ===========================================================================
  # DATABASE SERVICES
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg16
    container_name: ai_db_dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - backend_network

  mysql:
    image: mysql:8.0
    container_name: ecommerce_db_dev
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - backend_network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ===========================================================================
  # EMAIL
  # ===========================================================================


  mailhog:
    image: mailhog/mailhog
    container_name: mailhog
    platform: linux/amd64
    restart: unless-stopped
    ports:
      - "1025:1025" # SMTP port
      - "8025:8025" # Web UI port
    networks:
      - backend_network

  # ===========================================================================
  # APPLICATION SERVICES
  # ===========================================================================
  app_backend:
    build:
      context: ..
      dockerfile: backend/Dockerfile_dev
    container_name: ecommerce_backend
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "5005:5005" # Remote debugging
    volumes:
      - ../ecommerce-monorepo/storage-local:/app/product-images
    depends_on:
      mysql:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE}
      SPRING_DATASOURCE_URL: ${BACKEND_DATASOURCE_URL}
      DB_USERNAME: ${MYSQL_USER}
      DB_PASSWORD: ${MYSQL_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      STORAGE_SECRET_SALT: ${STORAGE_SECRET_SALT}
      PAYMENT_SERVICE_URL: ${PAYMENT_SERVICE_INTERNAL_URL}
      JAVA_OPTS: -agentlib:jdwp=transport=dt_socket,server=y,suspend=n,address=*:5005
    networks:
      - backend_network
      - frontend_network

  app_notification_service:
    build:
      context: ..
      dockerfile: notification-service/Dockerfile_dev
    container_name: ecommerce_notification_service
    restart: unless-stopped
    ports:
      - "8081:8081" # Use a different host port
      - "5006:5005" # Remote debugging
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: container
      SPRING_MAIL_HOST: mailhog
      SPRING_MAIL_PORT: 1025
    networks:
      - backend_network

  app_payment_service:
    build:
      context: ..
      dockerfile: payment-service/Dockerfile_dev
    container_name: ecommerce_payment_service
    restart: unless-stopped
    ports:
      - "8010:8010"
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      SPRING_PROFILES_ACTIVE: container
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_PUBLISHABLE_KEY: ${STRIPE_PUBLISHABLE_KEY}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET}
    networks:
      - backend_network

  # ===========================================================================
  # MONITORING SERVICES
  # ===========================================================================
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    ports:
      - "9090:9090"
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command: --config.file=/etc/prometheus/prometheus.yml
    networks:
      - backend_network

  grafana:
    image: grafana/grafana-oss:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3030:3000"
    environment:
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_ADMIN_PASSWORD}
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - prometheus
    networks:
      - backend_network

# =============================================================================
# VOLUMES & NETWORKS
# =============================================================================
volumes:
  postgres_data:
  mysql_data:
  grafana_data:

networks:
  backend_network:
    driver: bridge
  frontend_network:
    driver: bridge